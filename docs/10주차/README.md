# 응급처리

## 17.1 서버 과부하
- 사용자 수가 늘경우
    - MySQL 서버가 평상시에 2~30% 자원만 사용하도록 유지
- 사용자의 행동 패턴이 바뀌었을 경우
    - 쿼리나 실행빈도를 적절히 튜닝 
- 서버 과부화로 어떤 쿼리도 처리 안되면
    - 서버 재시작

### 17.1.1. 운영체제의 유틸리티를 이용해 장비의 부하 확인
- 서버에 MySQL 서버인지 아니면 다른 소프트웨어가 문제인지 확인을 해야함 
    - 운영체제 유틸리티를 이용해 상태확인

#### 시스템의 전체적인 부하 확인
```shell
// 해당 서버의 CPU가 처리해야 하는 작업이 얼마나 쌓여있는지 확인
shell > uptime    
    12:16:50 up 30 days, 10:39, 1 use5r, load average: 3.34, 1.80, 0.59
```
- load average : 최근 1분, 5분, 15분간의 CPU 작업 대기 규에서 처리를 기다리는 프로세스의 평균개수
    - 값이 1 이상이라는 것은 운영체제가 처리해야할 작업이 평균적으로 하나는 쿠에서 기다리고 있음을 의미
```shell
// 현재 CPU가 어떤 작업에 주로 사용되고 있는지를 알아봄
shell> vmstat 1
// 1초 동안 샘플링된 상태 값을 1초 단위로 출력
```
- vmstat : 가상메모리의 상태를 보여주는 명령이지만, CPU나 프로세스 큐를 확인하는 용도로 더 많이 사용
#### 메모리 사용률
```shell
// 운영체제가 사용하는 물리적 메모리나 스왑 영역의 상태를 확인
shell > free -m -t
// -m : MB로 표시
// -t : Total라인 표시
```
- 가로는 메모리가 사용하는 용도를 표시
- 세로는 물리적 메모리와 스왑 영역의 메모리의 구분을 표시
    - 스왑 영역 :  물리적인 메모리가 아니라 디스크에 준비된 가상의 메모리 공간을 의미
        - 물리적인 메모리가 부족할 땐를 대비해 디스크 특정 공간을 가상메모리처럼 사용 할수 있는 공간
        - 가능하면 사용하지 않는것이 좋지만 물리적인 메모리가 부족한경우 값이 높아짐

#### 디스크 사용량
```shell
// 장착된 디스크가 얼마나 사용되고 있는지 보여줌
shell > iostat -dx 1
```

### 17.1.2. MySQL 서버의 에러 로그 확인
```shell
shell> less +G mysqld.err
// +G : 파일의 마지막부터 보여줌
```

### 17.1.3. MySQL 서버의 프로세스 리스트 확인
- 현재 MySQL 서버에 존재하는 전체 프로세스 목록
- 각 프로세스가 어떤 작업(SQL)를 실행하고 있는지
- 각 작업의 현재상태
- 각 작업의 실행시간
```sql
// MySQL 서버에 접속된 클라이언트 수만큼의 레코드를 출력
mysql > show processlist
Id   |User  |Host                |db    |Command|Time|State|Info                                                                            |
-----+------+--------------------+------+-------+----+-----+--------------------------------------------------------------------------------+
19461|admin5|222.112.130.65:52878|admin5|Sleep  |   7|     |                                                                                |
19462|admin5|222.112.130.65:52879|admin5|Sleep  |  17|     |                                                                                |
19463|admin5|222.112.130.65:52880|admin5|Sleep  |  17|     |                                                                                |
19464|admin5|222.112.130.65:52883|admin5|Sleep  |  12|     |                                                                                |
19465|admin5|222.112.130.65:52885|admin5|Query  |   0|init |/* ApplicationName=DBeaver 21.0.5 - SQLEditor <Script-5.sql> */ show processlist|
```
- command : 'sleep'이나 'Binlog Dump' 상태가 아닌 프로세스는 대부분 클라이언트의 요청으로 SQL을 실행 하고 있음을 의미
- State 
    - 'Waiting...'일 때는 다른 프로세스가 선점하고 있다는 것을 의미하며, 해당 상태의 프로세스가 많은것은 대부분 테이블의 잠금을 획득하고 해제 하지않은 현상
    - 'Copy to tmp table'일 때는 쿼리의 처리를 위해 내부적인 임시 테이블로 복사하는 작업이 실행되고 있음을 의미하며, 테이블 구조를 변경하는 'ALTER TABLE'명령이 실행되거나 적절히 튜닝되지 못한 쿼리가 동시에 많이 실행될때 발생
```sql
// MySQL 서버에 접속된 클라이언트 수만큼의 레코드를 출력(자세하게)
mysql > show full processlist
Id   |User  |Host                |db    |Command|Time|State|Info                                                                            |
-----+------+--------------------+------+-------+----+-----+--------------------------------------------------------------------------------+
19461|admin5|222.112.130.65:52878|admin5|Sleep  |   7|     |                                                                                |
19462|admin5|222.112.130.65:52879|admin5|Sleep  |  17|     |                                                                                |
19463|admin5|222.112.130.65:52880|admin5|Sleep  |  17|     |                                                                                |
19464|admin5|222.112.130.65:52883|admin5|Sleep  |  12|     |                                                                                |
19465|admin5|222.112.130.65:52885|admin5|Query  |   0|init |/* ApplicationName=DBeaver 21.0.5 - SQLEditor <Script-5.sql> */ show processlist|
```    
> 가장 좋은 방법은 MySQL Enterprise Monitor 와같은 모니터링 도구를 이용

### 17.1.4. MySQL 서버의 최대 커넥션 설정 확인




