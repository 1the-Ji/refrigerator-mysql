

## 1주차 아키텍처

## 1.1 MySQL 전체구조

MySQL는 크게 응용프로그램 / MySQL 서버 / 운영체제 & 하드웨어 나뉘고

MySQL 서버는 크게 MySQL 엔진 / 스토리지 엔진으로 구분해서 볼 수 있다. 



### MySQL 엔진

- 클라이언트로부터 접속 및 쿼리 요청을 처리하는 커넥션 핸들러
- SQL 파서 및 전처리기
- 옵티마이저

3가지가 중심을 이룬다. 또한 성능 향상을 위해 MyISAM의 키 캐시, InnoDB의 버퍼 풀, 보조 저장소 기능이 포함되어있다.



### 스토리지 엔진

MySQL엔진은 요청된 SQL 문장을 분석하거나 최적화하고

실제 데이터를 디스크 스토리지에 저장하거나 디스크 스토리지로부터 데이터를 읽어오는 부분은 스토리지 엔진이 전담한다. 



MySQL 서버에서 MySQL 엔진은 하나지만 스토리지 엔진은 여러개를 사용할 수 있다. 



### 핸들러 API

MySQL 엔진의 쿼리 실행기에서 데이터 쓰거나 읽어야 할 때는 스토리지 엔진에게 요청을 "핸들러 요청"이라고 한다. 

핸들러 API를 이용해 MySQL 엔진과 데이터를 주고 받는다. 

~~~sql
show global status like 'Handler%'
~~~

: show status - MySQL 데이타베이스의 현재 상황을 확인한다. 

global : 시스템 전역 변수값 반대로 SESSION이 존재하고 현재 연결에 유요한 값을 표시한다.

![MySQL](../img/show.png)

- referencs : https://dev.mysql.com/doc/refman/8.0/en/server-status-variables.html

 - Handler_read_first : Index의 첫번째 Node Access, FULL_INDEX_SCAN
 - Handler_read_key : 특정값으로 Tree Search를 통해 index Node를 선택하는 경우, INDEX_SEEK
 - Handler_read_next : 인덱스의 leaf노드들의 링크를 Range스캔할 경우
 - Handler_read_prev : 위와 반대로 역순 Range스캔
 - Handler_read_random : Sorting같은 Buffer에 저장된 row에 대한 Access
 - Handler_read_random_next : 데이터Block나 Temp Table에서 순차적으로 row를 읽는 경우,FULL_TABLE_SCAN

: 추후 index에서... 



## 1.2 스레딩 

프로세스 기반이 아닌, 스레드 기반으로 

포그라운드 / 백그라운드 두가지로 구분된다.

SQL 쓰기 작업은 지연(버퍼링)되어 처리될 수 있지만, 읽기 작업은 절대로 지연될 수 없다.

일반적으로 DBMS는 쓰기 작업은 버퍼링을 통한 일괄처리 기능이 탐재되어 있다. (InnoDB)

MyISAM의 경우는 사용자가 스레드가 직접 쓰기 작업까지 처리한다.

이러한 이유로 InnoDB에서는 insert / update / delete 디스크에 저장될떄가지 기다리지 않아도 되지만 

MyISAM의 경우 버퍼링 기능을 사용할 수 없다.

### 포그라운드(클라이언트) = 사용자 스레드

MySQL 서버에 접속된 클라이언트의 수만큼 존재하며 주로 클라이언트 사용자가 요청하는 쿼리 문장을 처리하는 것이 임무다.

클라이언트가 작업을 마치고 커넥션을 종료하면 해당 커넥션을 담당하던 스레드는 다시 스레드풀로 돌아간다.

만약 thread_cache_size보다 많으면 스레드풀로 돌아가지 않는다.

MySQL의 데이터 버퍼나 캐시로부터 데이터를 가져오고, 버퍼나 캐시에 없는 경우 직접 인덱스 파일로부터 데이터를 읽어와서 처리한다.

MyISAM 테이블 디스크 쓰기 작업까지 포그라운드 스레드가 처리하지만, InnoDB의 경우 디스크 기은 백그라운드 스레드가 처리한다.

### 백그라운드

마이아이삼의 경우에는 해당 사항이 별로 없다.

이노디비의 경우 인서트 버퍼, 로그 기록, 데이터 버퍼에서 디스크로 기록, 디스크에서 버퍼로 읽어들이는, 데드락 모니터링 등 여러가지 업무를 처리한다.


- 로그 스레드 : 로그를 디스크로 기록하는 작업
- 쓰기 스레드 : 버퍼의 데이터를 디스크로 내려 쓰는 작업, 해당 스레드 개수를 지정할 수 있다. (innodb_write_io_threads)


## 1.3 메모리 

크게 글로벌 / 로컬 두가지 영역으로 구분된다.

- 글로벌 : MySQL 서버가 시작되면서 운영체제로부터 할당된다 .

MySQL 수많은 스레드가 공유하는 자원이 글로벌, 아니면 로컬


- 로컬 : 세션 메모리 영역이라고 표현하며 클라이언트 스레드가 쿼리를 처리하는데 사용하는 메모리 영역이다. 

커넥션이 열려 있는 동안 남아있는 공간 (버퍼)과 쿼리 실행하는 순간에만 할당했다가 사라지는 공간(소트버퍼, 조인버퍼)도 있다.














